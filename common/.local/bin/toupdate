#!/bin/sh
set -eu

VOID_PACKAGES="${VOID_PACKAGES:-$HOME/void-packages}"

updates=$(curl -s 'https://repo-default.voidlinux.org/void-updates/void-updates/updates_abc%40pompel.me.txt')

if [ ! -d "$VOID_PACKAGES/.git" ]; then
    echo "$updates"
    exit 0
fi

updated=$(git -C "$VOID_PACKAGES" log --oneline -100 2>/dev/null | sed -n 's/^[a-f0-9]* \([^:]*\): update to \([0-9].*\)\.$/\1 \2/p' || echo "")

if [ -z "$updated" ]; then
    echo "$updates"
    exit 0
fi

echo "$updates" | while read -r line; do
    pkg=$(echo "$line" | awk '{print $1}')
    latest=$(echo "$updated" | grep "^$pkg " | head -1 | awk '{print $2}')
    if [ -z "$latest" ]; then
        echo "$line"
    fi
done