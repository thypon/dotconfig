#!/bin/bash

# Get current directory's remote origin
remote_url=$(git remote get-url origin 2>/dev/null)
if [[ -z "$remote_url" ]]; then
    echo "Error: Not in a git repository or no origin remote found"
    exit 1
fi

# Extract org/repo from remote URL
org_repo=$(echo "$remote_url" | sed -E 's#.*github\.com[:/]([^/]+/[^/\.]+).*#\1#')
if [[ "$org_repo" == "$remote_url" ]]; then
    echo "Error: Could not parse GitHub repository from remote URL"
    exit 1
fi

# Get current branch and find associated PR
current_branch=$(git branch --show-current)
pr_number=$(gh pr list --head "$current_branch" --json number --jq '.[0].number' 2>/dev/null)

if [[ -z "$pr_number" || "$pr_number" == "null" ]]; then
    echo "Error: No PR found for current branch '$current_branch'"
    exit 1
fi

echo "Cleaning up github-actions[bot] comments for PR #$pr_number in $org_repo..."

# Get and delete regular issue comments from github-actions[bot]
echo "=== DELETING ISSUE COMMENTS ==="
issue_comments=$(gh api "repos/$org_repo/issues/$pr_number/comments" --jq '.[] | select(.user.login == "github-actions[bot]") | .id' | cat)
if [[ -n "$issue_comments" ]]; then
    echo "$issue_comments" | while read comment_id; do
        echo "Deleting issue comment $comment_id"
        gh api -X DELETE "repos/$org_repo/issues/comments/$comment_id" | cat
    done
else
    echo "No issue comments found from github-actions[bot]"
fi

# Get github-actions[bot] review IDs and delete their comments
echo -e "\n=== DELETING REVIEW COMMENTS ==="
review_ids=$(gh api "repos/$org_repo/pulls/$pr_number/reviews" --jq '.[] | select(.user.login == "github-actions[bot]") | .id' | cat)
if [[ -n "$review_ids" ]]; then
    comment_ids=($(for review_id in $review_ids; do
        gh api "repos/$org_repo/pulls/$pr_number/reviews/$review_id/comments" --jq '.[].id' | cat
    done))

    if [[ ${#comment_ids[@]} -gt 0 ]]; then
        echo "Found ${#comment_ids[@]} review comments to delete"
        for comment_id in "${comment_ids[@]}"; do
            echo "Deleting review comment $comment_id"
            gh api -X DELETE "repos/$org_repo/pulls/comments/$comment_id" | cat
        done
    else
        echo "No review comments found in github-actions[bot] reviews"
    fi
else
    echo "No reviews found from github-actions[bot]"
fi

echo -e "\nCleanup completed!"