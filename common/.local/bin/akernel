#!/bin/sh
set -eu
# Compile an Android kernel and bundle device tree blobs
#make ARCH=arm CROSS_COMPILE=../../../prebuilts/gcc/linux-x86/arm/arm-eabi-4.8/bin/arm-eabi- -j8 zImage

DTS_FILES=$(perl -e 'while (<>) {$a = $1 if /CONFIG_ARCH_((?:MSM|QSD|MPQ)[a-zA-Z0-9]+)=y/; $r = $1 if /CONFIG_MSM_SOC_REV_(?!NONE)(\w+)=y/; $arch = $arch.lc("$a$r ") if /CONFIG_ARCH_((?:MSM|QSD|MPQ)[a-zA-Z0-9]+)=y/} print $arch;' .config)
cp ./arch/arm/boot/zImage /tmp/zImage.tmp
for DTS in $(find arch/arm/boot/dts/ | grep $DTS_FILES | egrep "\.dts$"); do
	dtc -p 1024 -O dtb -o /tmp/file.dtb $DTS
	cat /tmp/zImage.tmp /tmp/file.dtb > /tmp/zImage
	mv /tmp/zImage /tmp/zImage.tmp
done
TDIR=$(mktemp -d)
#mv /tmp/zImage.tmp $TDIR/boot.img-zImage
python -c "from droidtools import unpackbootimg; unpackbootimg.extract('boot.img', '$TDIR').build('out.img')"
